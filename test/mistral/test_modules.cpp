#include "setup/context.h"


int test_embedding() {
    std::shared_ptr<Parameters> params = get_params();

    Embedding emb(*params->global_weights["model.embed_tokens.weight"]);

    std::vector<size_t> idx{0, 31999};
    emb.forward(infer, idx);

    Tensor emb1 = infer.hidden_state.at({0});
    Tensor emb2 = infer.hidden_state.at({1});

    if (!equals(emb1.data[0], -2.1864e-36f)) {
        std::cout << "emb1[0][0] mismatch" << std::endl;
        return 1;
    }
    if (!equals(emb1.data[4095], -6.3947e-36f)) {
        std::cout << "emb1[0][-1] mismatch" << std::endl;
        return 1;
    }
    if (!equals(emb2.data[0], -0.0040f)) {
        std::cout << "emb2[-1][0] mismatch" << std::endl;
        return 1;
    }
    if (!equals(emb2.data[4095], -0.0025f)) {
        std::cout << "emb2[-1][-1] mismatch" << std::endl;
        return 1;
    }

    return 0;
}

RegisterTest embedding_reg("test embedding", &test_embedding);

int test_rotary_embedding_inv_freq(){
    std::shared_ptr<Parameters> params = get_params();

    RotaryEmbedding::init_freq(infer, params->config);

    Tensor expected(arena, {
            1.0000e+00, 8.6596e-01, 7.4989e-01, 6.4938e-01, 5.6234e-01, 4.8697e-01,
            4.2170e-01, 3.6517e-01, 3.1623e-01, 2.7384e-01, 2.3714e-01, 2.0535e-01,
            1.7783e-01, 1.5399e-01, 1.3335e-01, 1.1548e-01, 1.0000e-01, 8.6596e-02,
            7.4989e-02, 6.4938e-02, 5.6234e-02, 4.8697e-02, 4.2170e-02, 3.6517e-02,
            3.1623e-02, 2.7384e-02, 2.3714e-02, 2.0535e-02, 1.7783e-02, 1.5399e-02,
            1.3335e-02, 1.1548e-02, 1.0000e-02, 8.6596e-03, 7.4989e-03, 6.4938e-03,
            5.6234e-03, 4.8697e-03, 4.2170e-03, 3.6517e-03, 3.1623e-03, 2.7384e-03,
            2.3714e-03, 2.0535e-03, 1.7783e-03, 1.5399e-03, 1.3335e-03, 1.1548e-03,
            1.0000e-03, 8.6596e-04, 7.4989e-04, 6.4938e-04, 5.6234e-04, 4.8697e-04,
            4.2170e-04, 3.6517e-04, 3.1623e-04, 2.7384e-04, 2.3714e-04, 2.0535e-04,
            1.7783e-04, 1.5399e-04, 1.3335e-04, 1.1548e-04
    }, {64});

    if (!equals(expected, infer.inv_freq)){
        std::cout << "Rotary embedding inv freq mismatch" << std::endl;
        return 1;
    }

    return 0;
}

RegisterTest rotary_embedding_inv_freq_reg("test rotary embedding inv freq", &test_rotary_embedding_inv_freq);

int test_rotary_embedding(){
    std::shared_ptr<Parameters> params = get_params();

    RotaryEmbedding::init_freq(infer, params->config);

    infer.pos = 0;
    RotaryEmbedding::forward(infer);

    Tensor expected_cos0(arena, {
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.,
            1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1., 1.
    }, {params->config.head_dim});

    Tensor expected_sin0(arena, {
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.,
            0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0., 0.
    }, {params->config.head_dim});

    if (!equals(infer.cos, expected_cos0)){
        std::cout << "rotary embedding cos mismatch pos 0" << std::endl;
        return 1;
    }

    if (!equals(infer.sin, expected_sin0)){
        std::cout << "rotary embedding sin mismatch pos 0" << std::endl;
        return 1;
    }

    infer.pos = 3;
    RotaryEmbedding::forward(infer);

    Tensor expected_cos3(arena, {
            -0.9900, -0.8558, -0.6279, -0.3685, -0.1160, 0.1097, 0.3010, 0.4576,
            0.5828, 0.6811, 0.7574, 0.8162, 0.8610, 0.8952, 0.9210, 0.9406,
            0.9553, 0.9664, 0.9748, 0.9811, 0.9858, 0.9893, 0.9920, 0.9940,
            0.9955, 0.9966, 0.9975, 0.9981, 0.9986, 0.9989, 0.9992, 0.9994,
            0.9996, 0.9997, 0.9997, 0.9998, 0.9999, 0.9999, 0.9999, 0.9999,
            1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
            1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
            1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
            -0.9900, -0.8558, -0.6279, -0.3685, -0.1160, 0.1097, 0.3010, 0.4576,
            0.5828, 0.6811, 0.7574, 0.8162, 0.8610, 0.8952, 0.9210, 0.9406,
            0.9553, 0.9664, 0.9748, 0.9811, 0.9858, 0.9893, 0.9920, 0.9940,
            0.9955, 0.9966, 0.9975, 0.9981, 0.9986, 0.9989, 0.9992, 0.9994,
            0.9996, 0.9997, 0.9997, 0.9998, 0.9999, 0.9999, 0.9999, 0.9999,
            1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
            1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000,
            1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000, 1.0000
    }, {params->config.head_dim});

    Tensor expected_sin3(arena, {
            0.14112, 0.51731, 0.77827, 0.92964, 0.99325, 0.99397, 0.95363, 0.88917,
            0.81265, 0.73219, 0.65290, 0.57782, 0.50854, 0.44572, 0.38947, 0.33955,
            0.29552, 0.25688, 0.22308, 0.19358, 0.16790, 0.14557, 0.12617, 0.10933,
            0.09473, 0.08206, 0.07108, 0.06157, 0.05332, 0.04618, 0.03999, 0.03464,
            0.02999, 0.02598, 0.02250, 0.01948, 0.01687, 0.01461, 0.01265, 0.01095,
            0.00949, 0.00821, 0.00711, 0.00616, 0.00533, 0.00462, 0.00400, 0.00346,
            0.00300, 0.00260, 0.00225, 0.00195, 0.00169, 0.00146, 0.00127, 0.00109,
            0.00095, 0.00082, 0.00071, 0.00062, 0.00053, 0.00046, 0.00040, 0.00034,
            0.14112, 0.51731, 0.77827, 0.92964, 0.99325, 0.99397, 0.95363, 0.88917,
            0.81265, 0.73219, 0.65290, 0.57782, 0.50854, 0.44572, 0.38947, 0.33955,
            0.29552, 0.25688, 0.22308, 0.19358, 0.16790, 0.14557, 0.12617, 0.10933,
            0.09473, 0.08206, 0.07108, 0.06157, 0.05332, 0.04618, 0.03999, 0.03464,
            0.02999, 0.02598, 0.02250, 0.01948, 0.01687, 0.01461, 0.01265, 0.01095,
            0.00949, 0.00821, 0.00711, 0.00616, 0.00533, 0.00462, 0.00400, 0.00346,
            0.00300, 0.00260, 0.00225, 0.00195, 0.00169, 0.00146, 0.00127, 0.00109,
            0.00095, 0.00082, 0.00071, 0.00062, 0.00053, 0.00046, 0.00040, 0.00034
    }, {params->config.head_dim});

    if (!equals(infer.cos, expected_cos3)){
        std::cout << "rotary embedding cos mismatch pos 3" << std::endl;
        return 1;
    }

    if (!equals(infer.sin, expected_sin3)){
        std::cout << "rotary embedding sin mismatch pos 3" << std::endl;
        return 1;
    }

    return 0;
}

RegisterTest rotary_embeddingg("test rotary embedding", &test_rotary_embedding);


/*
int test_rmsnorm() {
    Tensor x(arena, {2.4f, 7.8f, 1.1f, 5.3f, 9.0f, 4.7f, 6.2f, 3.8f, 8.5f, 0.6f}, {10});
    Tensor g(arena, {0.8f, 1.2f, 1.0f, 0.9f, 1.1f, 1.3f, 0.7f, 1.0f, 1.2f, 0.95f}, {10});

    RMSNorm rms(g);
    Tensor out = rms.forward(x);

    Tensor expected(arena, {0.3371f, 1.6432f, 0.1931f, 0.8374f, 1.7380f, 1.0726f, 0.7619f, 0.6671f, 1.7906f, 0.1001f}, {10});

    if (!equals(out, expected)) {
        std::cout << "RMSNorm mismatch" << std::endl;
        return 1;
    }

    return 0;
}

RegisterTest rmsnorm_reg("test rmsnorm", &test_rmsnorm);
*/